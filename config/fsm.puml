@startuml YandyArm

skinparam state {
    BackgroundColor WhiteSmoke
    BorderColor DarkSlateGray
    FontSize 15
    FontColor Black
    Padding 12
    Margin 10
    BorderThickness 2
    RoundCorner 12
}

skinparam stateArrow {
    FontSize 12
    FontColor DarkBlue
}

' === 变量说明 (注释) ===
' bool has_mineral: 当前末端是否有矿
' int stored_count: 仓库里有几个矿 (0, 1, 2)
' bool grip_sensor: 夹爪传感器状态

state YandyArm {

    ' === 顶层初始状态 ===
    ' 系统启动默认进入运作模式（的初始状态 Disabled）
    [*] -> Operational

    ' ==============================================
    ' 正常运作模式
    ' ==============================================
    state Operational {

        ' 运作模式下的默认状态是禁用
        [*] -> Disabled

        state Disabled {
        }

        state ManualControl {
            ' [NULL状态] 正常规划

            ' --- 内部指令 ---
            ' 仅在 ManualControl 状态下有效，不触发状态切换
            ManualControl -> ManualControl : -CMD_RESET         / clear_accumulators
            ManualControl -> ManualControl : -CMD_SWITCH_GRIP   / toggle_gripper
            ManualControl -> ManualControl : -CMD_TOGGLE_HELD   / toggle_held_flag
            ManualControl -> ManualControl : -CMD_INC_STORE     / inc_storage_count
            ManualControl -> ManualControl : -CMD_DEC_STORE     / dec_storage_count
        }

        state FetchingMode {
            ' [FETCH状态]
        }

        state StorageMode {
            ' [STORE状态]
        }

        ' --- 子状态间的转换逻辑 ---

        ' A. 启用/禁用
        Disabled      ---> ManualControl : CMD_SWITCH_ENABLE / enable_output
        ManualControl ---> Disabled      : CMD_SWITCH_ENABLE / disable_output

        ' B. 抓取流程 (Switch Fetch)
        ' 进入
        ManualControl --> FetchingMode  : CMD_SWITCH_FETCH / enter_fetch

        ' 退出 (传感器检测在 action 中完成)
        FetchingMode  --> ManualControl : CMD_SWITCH_FETCH / leave_fetch_mode

        ' C. 存取流程 (Switch Store)
        ' 进入 (存/取逻辑在 guard+action 中判断)
        ManualControl --> StorageMode   : CMD_SWITCH_STORE [can_enter_store] / enter_store_mode
        ' 完成并返回
        StorageMode   --> ManualControl : CMD_SWITCH_STORE / store_finish
    }

    ' ==============================================
    ' 故障模式
    ' ==============================================
    state ErrorMode {
        ' 故障状态，禁止动作
        ' 等待 CMD_RESET
    }

    ' ==============================================
    ' 全局转换
    ' ==============================================
    Operational --> ErrorMode : CMD_ERROR / emergency_stop

    ' 复位错误：回到 Operational (进入 Operational 的初始状态 Disabled)
    ErrorMode   --> Operational : CMD_RESET / clear_error

}
@enduml